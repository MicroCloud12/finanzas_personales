{% extends 'base.html' %}
{% load static %}
{% load socialaccount %}

{% block content %}
<div class="container mx-auto mt-10 p-5">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Procesamiento Automático de Tickets</h1>
    
    <div class="bg-white p-8 rounded-lg shadow-md border border-gray-200">
        <h2 class="text-xl font-semibold mb-4">Paso 1: Conecta tu cuenta de Google Drive</h2>
        {% if user.socialaccount_set.all %}
            <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded" role="alert">
                <p class="font-bold">¡Conectado!</p>
                <p>Tu cuenta de Google Drive ya está vinculada.</p>
            </div>
        {% else %}
            {% endif %}
        
        <hr class="my-8">

        <h2 class="text-xl font-semibold mb-4">Paso 2: Iniciar la Sincronización</h2>
        <p class="text-gray-600 mb-5">
            Haz clic en el botón de abajo para buscar y procesar nuevos tickets en tu Google Drive. Esto puede tardar unos minutos.
        </p>

        {% if user.socialaccount_set.all %}
            <button id="sync-button" data-url="{% url 'procesar_drive' %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-lg">
                Sincronizar Tickets de Drive
            </button>
        {% else %}
            {% endif %}

        <div id="progress-wrapper" class="hidden mt-6">
            <p id="progress-text" class="text-center text-gray-700 mb-2">Procesando, por favor espera...</p>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
        </div>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const syncButton = document.getElementById('sync-button');
    const progressWrapper = document.getElementById('progress-wrapper');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    if (syncButton) {
        syncButton.addEventListener('click', function() {
            // 1. Preparamos la UI para mostrar el progreso
            syncButton.disabled = true;
            syncButton.textContent = 'Procesando...';
            progressWrapper.classList.remove('hidden');
            progressBar.style.width = '10%'; // Empezamos con un poco de progreso

            // 2. Llamamos a la vista que inicia la tarea
            fetch(this.dataset.url)
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        // 3. Si tenemos un ID, empezamos a consultar el estado
                        pollTaskStatus(data.task_id);
                    } else {
                        throw new Error(data.error || 'No se pudo iniciar la tarea.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    progressText.textContent = 'Error al iniciar. Intenta de nuevo.';
                    progressBar.classList.add('bg-red-500');
                    syncButton.disabled = false;
                    syncButton.textContent = 'Sincronizar Tickets de Drive';
                });
        });
    }

    function pollTaskStatus(taskId) {
        const interval = setInterval(() => {
            fetch(`/task-status/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    // Actualizamos la barra de progreso
                    let currentWidth = parseFloat(progressBar.style.width) || 0;
                    if (currentWidth < 90) {
                        progressBar.style.width = (currentWidth + 10) + '%';
                    }

                    if (data.task_status === 'SUCCESS') {
                        // 4. ¡Tarea completada!
                        clearInterval(interval);
                        progressBar.style.width = '100%';
                        progressText.textContent = '¡Proceso completado! Redirigiendo...';
                        progressBar.classList.remove('bg-blue-600');
                        progressBar.classList.add('bg-green-500');
                        
                        // Redirigimos a la página de revisión
                        window.location.href = "{% url 'revisar_tickets' %}";
                    } else if (data.task_status === 'FAILURE') {
                        // La tarea falló
                        clearInterval(interval);
                        progressText.textContent = 'Ocurrió un error durante el procesamiento.';
                        progressBar.classList.add('bg-red-500');
                        syncButton.disabled = false;
                        syncButton.textContent = 'Sincronizar Tickets de Drive';
                    }
                    // Si el estado es PENDING o PROGRESS, no hacemos nada y el intervalo seguirá consultando.
                });
        }, 2000); // Consultamos cada 2 segundos
    }
});
</script>
{% endblock %}